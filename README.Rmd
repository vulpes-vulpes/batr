---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# batr

<!-- badges: start -->
[![R-CMD-check](https://github.com/vulpes-vulpes/batr/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/vulpes-vulpes/batr/actions/workflows/R-CMD-check.yaml)
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
<!-- badges: end -->

**batr** streamlines analysis and reporting of bat acoustic monitoring data containing [GUANO metadata](https://guano-md.org/). The package provides tools to extract GUANO metadata directly from WAV files, create summaries and visualizations, generate automated reports, and facilitate manual vetting workflows.

Developed as part of conservation research by the [Toronto Zoo's Native Bat Conservation Program](https://www.torontozoo.com/bats), batr is designed to support large-scale acoustic monitoring projects. The package is species-agnostic and works with any GUANO-compliant species identification codes.

## Key Features

- **GUANO Import**: Extract metadata directly from WAV files with flexible add/update capabilities
- **Device Support**: Import log files from Anabat Swift, Wildlife Acoustics SM3BAT/SM4BAT/SMmini, and Titley Ranger
- **Visualization Suite**: Create publication-quality plots for activity patterns, phenology, and spatial distributions
- **Automated Reporting**: Generate single-site and multi-site PDF reports with customizable templates
- **Manual Vetting**: Extract stratified or random file samples for quality control workflows
- **Survey Effort Tracking**: Visualize recorder uptime and data gaps to contextualize results

Check development progress and latest changes in [NEWS.md](https://github.com/vulpes-vulpes/batr/blob/main/NEWS.md).

## Installation

Install the development version from [GitHub](https://github.com/vulpes-vulpes/batr):

``` r
# install.packages("pak")
pak::pak("vulpes-vulpes/batr")
```

Or using devtools:

``` r
# install.packages("devtools")
devtools::install_github("vulpes-vulpes/batr")
```

### Optional: Basemap Support

Location maps can optionally include background basemaps showing geographic context. This requires the **ggspatial** package and its spatial dependencies:

``` r
install.packages(c("ggspatial", "sf", "ggrepel"))
```

**Note:** The sf package can be challenging to install as it requires system-level geospatial libraries (GDAL, GEOS, PROJ). If you encounter installation issues:

- **macOS:** Install dependencies via Homebrew: `brew install gdal geos proj`
- **Ubuntu/Debian:** `sudo apt-get install libgdal-dev libgeos-dev libproj-dev`
- **Windows:** Binary packages usually work without additional setup
- **Help:** See the [sf package installation guide](https://r-spatial.github.io/sf/#installing) for detailed troubleshooting

Basemap functionality is entirely optional—all core batr features work without these packages.

## Quick Start

### Prerequisites: GUANO Metadata

batr requires WAV files with [GUANO metadata](https://github.com/riggsd/guano-spec/blob/master/guano_specification.md) (Grand Unified Acoustic Notation Ontology). GUANO is supported by most modern bat recording devices and analysis software including SonoBat, Kaleidoscope, AnalookW, and others.

**Minimum required fields:**

- **Species identification**: `Species Auto ID` or `Species Manual ID` (manual takes precedence)
- **Site identifier**: A custom field containing unique location names (specified as `site_col` during import)
- **Timestamp**: Recording date and time (GUANO standard field)
- **Coordinates**: `Loc Position` in decimal degrees format (e.g., "43.123456 -79.654321")

### Basic Workflow

```r
library(batr)

# 1. Import GUANO metadata from WAV files
import_guano(
  action = "New",
  input_path = "path/to/wav/files",
  site_col = "Site",
  timezone = "America/Toronto",
  data_path = "project_data.RData"
)

# 2. Import recorder log files (optional but recommended)
import_logs(
  log_path = "path/to/log/files",
  data_path = "project_data.RData"
)

# 3. Create summary table
summary_table("project_data.RData")

# 4. Generate visualizations
species_daily_site_plot(
  data_path = "project_data.RData",
  species = "Mylu",
  gaps = TRUE
)

# 5. Generate automated reports
single_site_report(
  data_path = "project_data.RData",
  site = "Site1",
  output_dir = "reports"
)
```

## Core Functions

### Data Import

#### `import_guano()` - Extract metadata from WAV files

Reads GUANO metadata directly from WAV files and consolidates it into a portable RData file. This one-time import process extracts all essential information without requiring the large WAV files for subsequent analyses.

**Actions:**
- `"New"`: Create a new RData file from WAV files
- `"Add"`: Add new files to an existing RData file
- `"Update"`: Update metadata for files that where GUANO has been updated, for example after manual vetting

**Performance note:** Reading thousands of files takes time (potentially hours for large datasets). Use an SSD if possible and complete major vetting before initial import.

#### `import_logs()` - Import recorder activity logs

Import log files from bat detectors to track survey effort and identify data gaps. Essential for distinguishing true absences from recorder downtime.

**Supported devices:**
- **Anabat Swift**: Directory of daily CSV logs (one directory per site, directoryname matching GUANO location)
- **Titley Ranger**: Log files following Anabat Swift naming conventions
- **Wildlife Acoustics** (SM3BAT/SM4BAT/SMmini): Summary TXT files (filename matching GUANO location; if a site has multiple summary files, append a hyphen and number, e.g., `SiteA-1.txt`, `SiteA-2.txt`)

### Visualization

#### Activity Plots
- `species_daily_site_plot()`: Nightly activity for one species across sites
- `species_activity_facet_plot()`: Multi-species activity comparison
- `monthly_activity_plot()`: Monthly activity patterns by species
- `monitoring_effort_plot()`: Recorder uptime visualization with gap identification

#### Phenology & Timing
- `first_observations_plot()`: First nightly detection times relative to sunset

#### Spatial
- `location_map_plot()`: Geographic distribution of monitoring sites with optional basemaps

**Basemap support:** Location maps can include background maps (OpenStreetMap, terrain, etc.) by setting `basemap = TRUE` and choosing a `basemap_type`. Requires the **ggspatial**, **sf**, and **ggrepel** packages (see Installation section for setup details).

### Analysis & Reporting

#### `summary_table()` - Species × site summary

Generate a data frame or formatted table showing observation counts by species and location.

#### `single_site_report()` & `multi_site_report()`

Automated PDF reports with activity plots, phenology charts, site maps, and summary tables. Fully customizable using RMarkdown templates.

**Basemap option:** Set `map = TRUE` (single-site) or `basemap = TRUE` (multi-site) to include maps with geographic context. Requires optional spatial packages.

#### `manual_vet_extractor()`

Extract random or stratified samples of files for manual quality control. Supports:
- Simple random sampling by species
- Stratified sampling by location and species
- Filtering by existing manual IDs
- Automatic handling of missing files

### Custom Reports

Create custom report templates using RMarkdown. See `vignette("custom-reports")` for details on accessing data objects and creating tailored analyses.

## Data Management

### The RData Workflow

batr uses a consolidated RData file approach for efficiency:

1. **Import once**: Read GUANO from thousands of WAV files (slow)
2. **Analyze anywhere**: Use the portable RData file (fast)
3. **Update as needed**: Add new data or update changed identifications

**Why RData?** 
- WAV files are large (hundreds of GB) but only metadata is needed for analysis
- Reading thousands of small WAV files repeatedly is extremely slow
- Consolidated data enables faster iteration and reproducible analyses

### Updating Projects

```r
# Add new monitoring data to existing project
import_guano(
  action = "Add",
  input_path = "path/to/new/files",
  site_col = "Site",
  timezone = "America/Toronto",
  data_path = "project_data.RData"
)

# Update files with revised identifications
import_guano(
  action = "Update",
  input_path = "path/to/updated/files",
  site_col = "Site",
  timezone = "America/Toronto",
  data_path = "project_data.RData"
)
```

## Documentation & Support

- **Function reference**: See package documentation (`?batr`)
- **Vignettes**: 
  - `vignette("batr")`: Package overview
  - `vignette("custom-reports")`: Creating custom report templates
- **Issues**: [GitHub Issues](https://github.com/vulpes-vulpes/batr/issues)
- **Contributions**: Feedback and contributions welcome!
- **Get in touch**: Suggestions, bug reports, and feature requests are encouraged—please open an issue or start a discussion on GitHub.

## Citation

If you use batr in your research, please cite:

```
Thorne, T. (2026). batr: Bat Acoustic Monitoring Analysis and Reporting. 
R package version 0.2.2. https://github.com/vulpes-vulpes/batr
```

## Acknowledgments

- GUANO metadata specification by [David Riggs](https://github.com/riggsd/guano-r)
- Developed to support the [Toronto Zoo Native Bat Conservation Program](https://www.torontozoo.com/bats)
- Built with: ggplot2, data.table, lubridate, and the broader R ecosystem

## License

GPL-3 (see [LICENSE](LICENSE) file)
