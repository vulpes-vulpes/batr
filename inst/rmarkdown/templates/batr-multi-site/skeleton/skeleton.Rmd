---
output:
  pdf_document:
    toc: false
    keep_tex: false
    extra_dependencies: ["booktabs", "geometry"]
header-includes:
  - \usepackage{helvet}
  - \renewcommand\familydefault{\sfdefault}
  - \usepackage{caption}
  - \captionsetup{justification=raggedright, singlelinecheck=false, font=small, labelfont=bf}
geometry:
- top=20mm
- left=20mm
fontsize: 11pt
urlcolor: blue
params:
  data_path: !r NA_character_
  sites: !r c("Site1", "Site2")
  species: !r c("Epfu")
  author: !r NA_character_
  project_name: !r NA_character_
  monitoring_start: !r NA_character_
  monitoring_end: !r NA_character_
  include_map: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center"
)

library(batr)
library(kableExtra)
library(lubridate)
library(data.table)

# Load data
load(params$data_path)

# Filter to specified sites and species
observations <- observations[
  observations$Species %in% params$species &
  observations$Location %in% params$sites, 
]

if (nrow(observations) == 0) {
  stop("No observations found for specified sites and species")
}

# Filter active_dates if provided
if (exists("active_dates")) {
  active_dates <- active_dates[active_dates$Location %in% params$sites, ]
}

# Determine monitoring period
if (is.null(params$monitoring_start)) {
  mon_start <- min(observations$Night, na.rm = TRUE)
} else {
  mon_start <- as.Date(params$monitoring_start)
}

if (is.null(params$monitoring_end)) {
  mon_end <- max(observations$Night, na.rm = TRUE)
} else {
  mon_end <- as.Date(params$monitoring_end)
}

n_sites <- length(params$sites)
n_species <- length(unique(observations$Species))
n_observations <- nrow(observations)
```

# `r params$project_name`

## Multi-Site Report

**Prepared by:** `r params$author`  
**Report Date:** `r format(Sys.Date(), '%B %d, %Y')`  
**Monitoring Period:** `r format(mon_start, '%b %d, %Y')` to `r format(mon_end, '%b %d, %Y')`  
**Sites Included:** `r paste(params$sites, collapse = ", ")`

---

## Summary

A total of **`r n_species`** bat species were detected across **`r n_sites`** monitoring locations during the monitoring period, with a combined total of **`r n_observations`** acoustic observations over **`r as.integer(mon_end - mon_start)`** nights.

## Site Comparison

```{r site_comparison}
# Calculate summary statistics by site including recorder model
site_stats <- data.table(observations)[, 
  .(
    Model = if("Model" %in% names(.SD)) paste(unique(Model), collapse = ", ") else "Unknown",
    N_Observations = .N,
    N_Species = length(unique(Species)),
    N_Nights = length(unique(Night))
  ), 
  by = Location
][order(Location)]

kable(site_stats,
      format = "latex",
      booktabs = TRUE,
      col.names = c("Site", "Recorder", "Observations", "Species", "Monitoring Nights"),
      caption = "Summary statistics by monitoring site") %>%
  kable_styling(latex_options = c("hold_position", "scale_down"))
```

## Species Observations by Site

```{r summary_table, fig.cap="Total species observations by site."}
# Use batr's summary_table function
summary <- batr::summary_table(
  data_path = params$data_path,
  species_list = params$species,
  location_list = params$sites,
  include_totals = TRUE
)

kable(summary, 
      format = "latex",
      booktabs = TRUE,
      caption = "Species observations across all monitoring sites") %>%
  kable_styling(latex_options = c("hold_position", "scale_down"))
```

\newpage

## Activity Patterns Across Sites

Nightly activity of all species by site throughout the monitoring period is shown below.

```{r activity_plot, fig.cap="Nightly bat observations by species and site.", fig.height=6.5, fig.width=7}
# Use batr's species_daily_site_plot function
batr::species_daily_site_plot(
  data_path = params$data_path,
  species = params$species,
  location_list = params$sites,
  gaps = exists("active_dates"),
  text_size = 9,
  date_breaks = "2 weeks"
)
```

\newpage

## Monitoring Effort

Monitoring effort at all locations throughout the monitoring period. Grey bars indicate nights with no monitoring effort.

```{r monitoring_plot, fig.cap="Monitoring effort by site over time.", fig.height=6.5, fig.width=7}
tryCatch({
  batr::monitoring_effort_plot(
    data_path = params$data_path,
    location_list = params$sites,
    monitoring_start = mon_start,
    monitoring_end = mon_end,
    date_breaks = "2 weeks"
  )
}, error = function(e) {
  plot.new()
  text(0.5, 0.5, "Monitoring effort data not available", cex = 1.5)
})
```

\newpage

## Monitoring Locations

```{r location_info}
# Extract unique locations with coordinates
unique_locs <- unique(observations[, c("Location", "Latitude", "Longitude")])
unique_locs <- unique_locs[order(unique_locs$Location), ]
rownames(unique_locs) <- NULL

kable(unique_locs,
      format = "latex",
      booktabs = TRUE,
      caption = "Monitoring site coordinates") %>%
  kable_styling(latex_options = "hold_position")
```

```{r location_map, fig.cap="Monitoring location map", fig.height=4, fig.width=6, eval=params$include_map}
# Save filtered observations to temporary RData for site-specific map
temp_map_file <- tempfile(fileext = ".RData")
save(observations, file = temp_map_file)

batr::location_map_plot(
  data_path = temp_map_file,
  location_list = params$site,
  text_size = 10,
  point_size = 4,
  plot_title = NULL
)

unlink(temp_map_file)
```


\newpage

## Notes

```{r notes, results='asis', echo=FALSE}
# Check if any manual IDs exist
has_manual_ids <- "Species.Manual.ID" %in% names(observations) && 
                  any(!is.na(observations$Species.Manual.ID))

cat("- This report is automatically generated from acoustic monitoring data\n")

if (has_manual_ids) {
  cat("- Species identifications include manual verification\n")
} else {
  cat("- Species identifications are based on automated classification and should be verified\n")
}

cat("- The number of observations cannot be directly compared between species, as detection varies by echolocation call characteristics\n")
cat("- Comparison between sites should account for differences in monitoring effort and equipment\n")
cat("- For additional analysis or questions, please contact the research team\n")
```

---

*Report generated using the [batr R package](https://github.com/vulpes-vulpes/batr) by Toby Thorne*
